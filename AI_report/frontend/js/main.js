const routeTable = {
  "æ²³é‚Š": {
    "é…’é¤¨": [
      [{"x": 309, "y": 188}, {"x": 364, "y": 152}, {"x": 520, "y": 217}],
      [{"x": 304, "y": 195}, {"x": 374, "y": 153}, {"x": 436, "y": 193}, {"x": 535, "y": 137}, {"x": 587, "y": 178}],
      [{"x": 301, "y": 186}, {"x": 368, "y": 151}, {"x": 538, "y": 247}, {"x": 583, "y": 213}],
      [{"x": 308, "y": 185}, {"x": 365, "y": 153}, {"x": 435, "y": 191}, {"x": 502, "y": 142}, {"x": 588, "y": 169}]
    ],  // e.g. [{ x:40, y:180 }, { x:80, y:220 }, â€¦]
    "ææ¸…ç…§å®¶":       [
      [{"x": 229, "y": 240}],
      [{"x": 208, "y": 280}],
      [{"x": 139, "y": 283}],
      [{"x": 176, "y": 249}]
    ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
      [{"x": 245, "y": 292}, {"x": 195, "y": 263}, {"x": 172, "y": 201}],
      [{"x": 252, "y": 242}, {"x": 186, "y": 265}, {"x": 82, "y": 245}],
      [{"x": 188, "y": 262}, {"x": 111, "y": 204}],
      [{"x": 188, "y": 262}, {"x": 149, "y": 233}]
    ],
    "èŠå­å®¶":         [
      [{"x": 275, "y": 279}, {"x": 339, "y": 329}],
      [{"x": 483, "y": 261}, {"x": 221, "y": 385}],
      [{"x": 277, "y": 281}, {"x": 344, "y": 332}, {"x": 453, "y": 274}],
      [{"x": 274, "y": 288}, {"x": 344, "y": 333}, {"x": 268, "y": 356}]
    ],
    "åŸé–€":           [
      [{"x": 519, "y": 277}, {"x": 391, "y": 350}, {"x": 464, "y": 400}],
      [{"x": 544, "y": 297}, {"x": 400, "y": 354}, {"x": 499, "y": 424}, {"x": 550, "y": 380}],
      [{"x": 574, "y": 309}, {"x": 384, "y": 392}],
      [{"x": 570, "y": 302}, {"x": 427, "y": 377}, {"x": 506, "y": 421}, {"x": 608, "y": 413}]
    ],
    "è¡™é–€":           [
      [{"x": 500, "y": 281}, {"x": 588, "y": 229}, {"x": 625, "y": 253}],
      [{"x": 503, "y": 283}, {"x": 640, "y": 188}, {"x": 689, "y": 219}, {"x": 657, "y": 231}],
      [{"x": 502, "y": 284}, {"x": 555, "y": 248}, {"x": 589, "y": 277}, {"x": 648, "y": 267}],
      [{"x": 502, "y": 284}, {"x": 555, "y": 248}, {"x": 589, "y": 277}, {"x": 648, "y": 267}]
    ],
    "è¨ºæ‰€":           [
      [{"x": 499, "y": 284}, {"x": 732, "y": 143}, {"x": 698, "y": 121}],
      [{"x": 500, "y": 277}, {"x": 693, "y": 175}, {"x": 656, "y": 144}],
      [{"x": 307, "y": 181}, {"x": 372, "y": 147}, {"x": 441, "y": 201}, {"x": 598, "y": 102}, {"x": 633, "y": 126}],
      [{"x": 308, "y": 187}, {"x": 368, "y": 151}, {"x": 427, "y": 199}, {"x": 554, "y": 125}, {"x": 626, "y": 164}]
    ],
    "æ›¸é™¢":           [
      [{"x": 308, "y": 181}, {"x": 366, "y": 149}, {"x": 425, "y": 189}, {"x": 595, "y": 108}, {"x": 528, "y": 53}],
      [{"x": 306, "y": 183}, {"x": 464, "y": 86}],
      [{"x": 308, "y": 187}, {"x": 406, "y": 119}],
      [{"x": 304, "y": 185}, {"x": 362, "y": 148}, {"x": 423, "y": 188}, {"x": 496, "y": 144}, {"x": 452, "y": 109}]
    ],
    "æ²³é‚Š":  [
      [{"x": 337, "y": 192}],
      [{"x": 394, "y": 218}],
      [{"x": 416, "y": 252}],
      [{"x": 340, "y": 231}]
    ]
  },
  "é…’é¤¨": {
    "æ²³é‚Š":           [
      [{"x": 614, "y": 175}, {"x": 518, "y": 125}, {"x": 424, "y": 190}, {"x": 368, "y": 153}, {"x": 313, "y": 179}, {"x": 337, "y": 192}],
      [{"x": 605, "y": 169}, {"x": 536, "y": 129}, {"x": 426, "y": 183}, {"x": 362, "y": 149}, {"x": 304, "y": 193}, {"x": 394, "y": 218}],
      [{"x": 613, "y": 175}, {"x": 536, "y": 128}, {"x": 423, "y": 189}, {"x": 364, "y": 152}, {"x": 285, "y": 197}, {"x": 416, "y": 252}],
      [{"x": 616, "y": 172}, {"x": 533, "y": 125}, {"x": 427, "y": 183}, {"x": 365, "y": 153}, {"x": 296, "y": 194}, {"x": 340, "y": 231}]
    ],
    "ææ¸…ç…§å®¶":       [
      [{"x": 608, "y": 173}, {"x": 524, "y": 129}, {"x": 429, "y": 190}, {"x": 368, "y": 150}, {"x": 265, "y": 202}, {"x": 317, "y": 236}, {"x": 204, "y": 293}],
      [{"x": 607, "y": 174}, {"x": 529, "y": 128}, {"x": 444, "y": 184}, {"x": 357, "y": 148}, {"x": 277, "y": 208}, {"x": 319, "y": 244}, {"x": 181, "y": 319}, {"x": 148, "y": 292}],
      [{"x": 612, "y": 173}, {"x": 520, "y": 128}, {"x": 416, "y": 190}, {"x": 357, "y": 157}, {"x": 268, "y": 211}, {"x": 313, "y": 237}, {"x": 232, "y": 285}, {"x": 176, "y": 242}],
      [{"x": 611, "y": 170}, {"x": 534, "y": 122}, {"x": 436, "y": 189}, {"x": 365, "y": 152}, {"x": 270, "y": 215}, {"x": 318, "y": 240}, {"x": 247, "y": 284}, {"x": 232, "y": 258}]
    ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
      [{"x": 608, "y": 173}, {"x": 524, "y": 129}, {"x": 429, "y": 190}, {"x": 368, "y": 150}, {"x": 265, "y": 202}, {"x": 317, "y": 236}, {"x": 204, "y": 293},{"x": 73, "y": 250}],
      [{"x": 608, "y": 173}, {"x": 524, "y": 129}, {"x": 429, "y": 190}, {"x": 368, "y": 150}, {"x": 265, "y": 202}, {"x": 317, "y": 236}, {"x": 204, "y": 293},{"x": 112, "y": 226}],
      [{"x": 608, "y": 173}, {"x": 524, "y": 129}, {"x": 429, "y": 190}, {"x": 368, "y": 150}, {"x": 265, "y": 202}, {"x": 317, "y": 236}, {"x": 204, "y": 293},{"x": 142, "y": 204}],
      [{"x": 608, "y": 173}, {"x": 524, "y": 129}, {"x": 429, "y": 190}, {"x": 368, "y": 150}, {"x": 265, "y": 202}, {"x": 317, "y": 236}, {"x": 204, "y": 293},{"x": 182, "y": 209}]
    ],
    "èŠå­å®¶":         [
      [{"x": 608, "y": 166}, {"x": 631, "y": 188}, {"x": 260, "y": 393}],
      [{"x": 606, "y": 166}, {"x": 640, "y": 193}, {"x": 321, "y": 358}],
      [{"x": 609, "y": 170}, {"x": 640, "y": 193}, {"x": 402, "y": 324}],
      [{"x": 608, "y": 165}, {"x": 635, "y": 194}, {"x": 455, "y": 296}]
    ],
    "åŸé–€":           [
      [{"x": 612, "y": 173}, {"x": 641, "y": 189}, {"x": 377, "y": 345}, {"x": 457, "y": 389}],
      [{"x": 616, "y": 177}, {"x": 644, "y": 192}, {"x": 370, "y": 349}, {"x": 500, "y": 432}, {"x": 543, "y": 405}],
      [{"x": 609, "y": 171}, {"x": 648, "y": 197}, {"x": 350, "y": 357}, {"x": 403, "y": 386}],
      [{"x": 608, "y": 174}, {"x": 647, "y": 198}, {"x": 370, "y": 348}, {"x": 440, "y": 381}, {"x": 508, "y": 350}]
    ],
    "è¡™é–€":           [
      [{"x": 612, "y": 170}, {"x": 656, "y": 194}, {"x": 559, "y": 249}, {"x": 588, "y": 260}],
      [{"x": 616, "y": 173}, {"x": 649, "y": 196}, {"x": 556, "y": 254}, {"x": 623, "y": 295}, {"x": 635, "y": 280}],
      [{"x": 612, "y": 169}, {"x": 664, "y": 201}, {"x": 634, "y": 209}],
      [{"x": 608, "y": 166}, {"x": 698, "y": 230}, {"x": 672, "y": 241}]
    ],
    "è¨ºæ‰€":           [
      [{"x": 608, "y": 158}, {"x": 624, "y": 135}],
      [{"x": 608, "y": 173}, {"x": 632, "y": 192}, {"x": 693, "y": 166}],
      [{"x": 604, "y": 167}, {"x": 578, "y": 144}, {"x": 635, "y": 105}, {"x": 681, "y": 119}],
      [{"x": 612, "y": 169}, {"x": 639, "y": 185}, {"x": 654, "y": 177}]
    ],
    "æ›¸é™¢":           [
      [{"x": 614, "y": 173}, {"x": 560, "y": 142}, {"x": 536, "y": 156}, {"x": 462, "y": 114}, {"x": 384, "y": 121}],
      [{"x": 610, "y": 169}, {"x": 569, "y": 133}, {"x": 526, "y": 155}, {"x": 457, "y": 117}, {"x": 429, "y": 97}],
      [{"x": 616, "y": 174}, {"x": 560, "y": 146}, {"x": 544, "y": 156}, {"x": 464, "y": 114}, {"x": 464, "y": 76}],
      [{"x": 616, "y": 170}, {"x": 574, "y": 145}, {"x": 532, "y": 158}, {"x": 462, "y": 116}, {"x": 522, "y": 53}]
    ],
    "é…’é¤¨":[
      [{"x": 496, "y": 216}],
      [{"x": 534, "y": 162}],
      [{"x": 596, "y": 170}],
      [{"x": 568, "y": 220}]
    ]
  },
  "ææ¸…ç…§å®¶": {
    "æ²³é‚Š":           [
      [{"x": 211, "y": 280}, {"x": 230, "y": 295}, {"x": 340, "y": 201}],
      [{"x": 202, "y": 276}, {"x": 222, "y": 290}, {"x": 387, "y": 224}],
      [{"x": 208, "y": 281}, {"x": 240, "y": 294}, {"x": 392, "y": 220}, {"x": 436, "y": 236}],
      [{"x": 207, "y": 288}, {"x": 226, "y": 302}, {"x": 343, "y": 240}]
    ],
    "é…’é¤¨":           [
      [{"x": 222, "y": 296}, {"x": 323, "y": 233}, {"x": 273, "y": 204}, {"x": 360, "y": 145}, {"x": 496, "y": 216}],
      [{"x": 212, "y": 292}, {"x": 328, "y": 234}, {"x": 266, "y": 204}, {"x": 368, "y": 142}, {"x": 453, "y": 193}, {"x": 534, "y": 162}],
      [{"x": 222, "y": 293}, {"x": 317, "y": 229}, {"x": 276, "y": 203}, {"x": 364, "y": 141}, {"x": 460, "y": 194}, {"x": 530, "y": 140}, {"x": 596, "y": 170}],
      [{"x": 212, "y": 291}, {"x": 320, "y": 236}, {"x": 266, "y": 200}, {"x": 364, "y": 149}, {"x": 547, "y": 248}, {"x": 568, "y": 220}]
    ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
      [{"x": 220, "y": 285}, {"x": 73, "y": 246}],
      [{"x": 221, "y": 281}, {"x": 113, "y": 222}],
      [{"x": 234, "y": 289}, {"x": 140, "y": 197}],
      [{"x": 223, "y": 285}, {"x": 179, "y": 206}]
    ],
    "èŠå­å®¶":         [
      [{"x": 218, "y": 284}, {"x": 352, "y": 352}, {"x": 258, "y": 397}],
      [{"x": 217, "y": 281}, {"x": 358, "y": 350}, {"x": 321, "y": 360}],
      [{"x": 224, "y": 294}, {"x": 358, "y": 356}, {"x": 400, "y": 322}],
      [{"x": 229, "y": 290}, {"x": 360, "y": 349}, {"x": 458, "y": 297}]
    ],
    "åŸé–€":           [
      [{"x": 223, "y": 282}, {"x": 464, "y": 391}],
      [{"x": 224, "y": 285}, {"x": 507, "y": 433}, {"x": 544, "y": 406}],
      [{"x": 226, "y": 282}, {"x": 408, "y": 389}],
      [{"x": 230, "y": 289}, {"x": 420, "y": 382}, {"x": 508, "y": 352}]
    ],
    "è¡™é–€":           [
      [{"x": 226, "y": 287}, {"x": 372, "y": 354}, {"x": 548, "y": 248}, {"x": 587, "y": 259}],
      [{"x": 216, "y": 285}, {"x": 386, "y": 361}, {"x": 556, "y": 245}, {"x": 616, "y": 288}, {"x": 643, "y": 269}],
      [{"x": 240, "y": 297}, {"x": 380, "y": 355}, {"x": 616, "y": 208}],
      [{"x": 224, "y": 288}, {"x": 371, "y": 352}, {"x": 632, "y": 197}, {"x": 676, "y": 239}]
    ],
    "è¨ºæ‰€":           [
      [{"x": 235, "y": 278}, {"x": 323, "y": 233}, {"x": 254, "y": 209}, {"x": 360, "y": 154}, {"x": 434, "y": 194}, {"x": 595, "y": 109}, {"x": 632, "y": 123}],
      [{"x": 220, "y": 285}, {"x": 369, "y": 350}, {"x": 622, "y": 200}, {"x": 692, "y": 164}],
      [{"x": 212, "y": 285}, {"x": 318, "y": 229}, {"x": 264, "y": 195}, {"x": 364, "y": 149}, {"x": 456, "y": 185}, {"x": 624, "y": 89}, {"x": 679, "y": 113}],
      [{"x": 224, "y": 286}, {"x": 376, "y": 354}, {"x": 616, "y": 203}, {"x": 652, "y": 173}]
    ],
    "æ›¸é™¢":           [
      [{"x": 227, "y": 287}, {"x": 320, "y": 222}, {"x": 269, "y": 201}, {"x": 351, "y": 154}, {"x": 428, "y": 184}, {"x": 492, "y": 145}, {"x": 468, "y": 125}, {"x": 392, "y": 124}],
      [{"x": 227, "y": 289}, {"x": 324, "y": 231}, {"x": 268, "y": 209}, {"x": 370, "y": 145}, {"x": 428, "y": 184}, {"x": 496, "y": 137}, {"x": 464, "y": 116}, {"x": 428, "y": 94}],
      [{"x": 227, "y": 288}, {"x": 329, "y": 229}, {"x": 272, "y": 209}, {"x": 368, "y": 150}, {"x": 440, "y": 185}, {"x": 500, "y": 142}, {"x": 468, "y": 122}, {"x": 461, "y": 78}],
      [{"x": 228, "y": 289}, {"x": 318, "y": 238}, {"x": 273, "y": 213}, {"x": 356, "y": 146}, {"x": 416, "y": 181}, {"x": 552, "y": 109}, {"x": 522, "y": 61}]
    ],
    "ææ¸…ç…§å®¶": [
      [{"x": 208, "y": 288}],
      [{"x": 144, "y": 285}],
      [{"x": 176, "y": 239}],
      [{"x": 232, "y": 255}]
    ]
  },
  "ææ¸…ç…§å®¶çš„åº­é™¢": {
    "æ²³é‚Š":           [
      [{"x": 163, "y": 236},{"x": 211, "y": 280}, {"x": 230, "y": 295}, {"x": 340, "y": 201}],
      [{"x": 163, "y": 236},{"x": 202, "y": 276}, {"x": 222, "y": 290}, {"x": 387, "y": 224}],
      [{"x": 163, "y": 236},{"x": 208, "y": 281}, {"x": 240, "y": 294}, {"x": 392, "y": 220}, {"x": 436, "y": 236}],
      [{"x": 163, "y": 236},{"x": 207, "y": 288}, {"x": 226, "y": 302}, {"x": 343, "y": 240}] 
    ],
    "é…’é¤¨":           [
      [{"x": 163, "y": 236},{"x": 222, "y": 296}, {"x": 323, "y": 233}, {"x": 273, "y": 204}, {"x": 360, "y": 145}, {"x": 496, "y": 216}],
      [{"x": 163, "y": 236},{"x": 212, "y": 292}, {"x": 328, "y": 234}, {"x": 266, "y": 204}, {"x": 368, "y": 142}, {"x": 453, "y": 193}, {"x": 534, "y": 162}],
      [{"x": 163, "y": 236},{"x": 222, "y": 293}, {"x": 317, "y": 229}, {"x": 276, "y": 203}, {"x": 364, "y": 141}, {"x": 460, "y": 194}, {"x": 530, "y": 140}, {"x": 596, "y": 170}],
      [{"x": 163, "y": 236},{"x": 212, "y": 291}, {"x": 320, "y": 236}, {"x": 266, "y": 200}, {"x": 364, "y": 149}, {"x": 547, "y": 248}, {"x": 568, "y": 220}]

    ],
    "ææ¸…ç…§å®¶":       [
      [{"x": 135, "y": 241}, {"x": 208, "y": 288}],
      [{"x": 136, "y": 233}, {"x": 144, "y": 285}],
      [{"x": 140, "y": 237}, {"x": 176, "y": 239}],
      [{"x": 120, "y": 237}, {"x": 232, "y": 255}]
    ],
    "èŠå­å®¶":         [
      [{"x": 163, "y": 236},{"x": 218, "y": 284}, {"x": 352, "y": 352}, {"x": 258, "y": 397}],
      [{"x": 163, "y": 236},{"x": 217, "y": 281}, {"x": 358, "y": 350}, {"x": 321, "y": 360}],
      [{"x": 163, "y": 236},{"x": 224, "y": 294}, {"x": 358, "y": 356}, {"x": 400, "y": 322}],
      [{"x": 163, "y": 236},{"x": 229, "y": 290}, {"x": 360, "y": 349}, {"x": 458, "y": 297}]
    ],
    "åŸé–€":           [
      [{"x": 163, "y": 236},{"x": 223, "y": 282}, {"x": 464, "y": 391}],
      [{"x": 163, "y": 236},{"x": 224, "y": 285}, {"x": 507, "y": 433}, {"x": 544, "y": 406}],
      [{"x": 163, "y": 236},{"x": 226, "y": 282}, {"x": 408, "y": 389}],
      [{"x": 163, "y": 236},{"x": 230, "y": 289}, {"x": 420, "y": 382}, {"x": 508, "y": 352}]
    ],
    "è¡™é–€":           [
      [{"x": 163, "y": 236},{"x": 226, "y": 287}, {"x": 372, "y": 354}, {"x": 548, "y": 248}, {"x": 587, "y": 259}],
      [{"x": 163, "y": 236},{"x": 216, "y": 285}, {"x": 386, "y": 361}, {"x": 556, "y": 245}, {"x": 616, "y": 288}, {"x": 643, "y": 269}],
      [{"x": 163, "y": 236},{"x": 240, "y": 297}, {"x": 380, "y": 355}, {"x": 616, "y": 208}],
      [{"x": 163, "y": 236},{"x": 224, "y": 288}, {"x": 371, "y": 352}, {"x": 632, "y": 197}, {"x": 676, "y": 239}]
    ],
    "è¨ºæ‰€":           [
      [{"x": 163, "y": 236},{"x": 235, "y": 278}, {"x": 323, "y": 233}, {"x": 254, "y": 209}, {"x": 360, "y": 154}, {"x": 434, "y": 194}, {"x": 595, "y": 109}, {"x": 632, "y": 123}],
      [{"x": 163, "y": 236},{"x": 220, "y": 285}, {"x": 369, "y": 350}, {"x": 622, "y": 200}, {"x": 692, "y": 164}],
      [{"x": 163, "y": 236},{"x": 212, "y": 285}, {"x": 318, "y": 229}, {"x": 264, "y": 195}, {"x": 364, "y": 149}, {"x": 456, "y": 185}, {"x": 624, "y": 89}, {"x": 679, "y": 113}],
      [{"x": 163, "y": 236},{"x": 224, "y": 286}, {"x": 376, "y": 354}, {"x": 616, "y": 203}, {"x": 652, "y": 173}]
    ],
    "æ›¸é™¢":           [
      [{"x": 163, "y": 236},{"x": 227, "y": 287}, {"x": 320, "y": 222}, {"x": 269, "y": 201}, {"x": 351, "y": 154}, {"x": 428, "y": 184}, {"x": 492, "y": 145}, {"x": 468, "y": 125}, {"x": 392, "y": 124}],
      [{"x": 163, "y": 236},{"x": 227, "y": 289}, {"x": 324, "y": 231}, {"x": 268, "y": 209}, {"x": 370, "y": 145}, {"x": 428, "y": 184}, {"x": 496, "y": 137}, {"x": 464, "y": 116}, {"x": 428, "y": 94}],
      [{"x": 163, "y": 236},{"x": 227, "y": 288}, {"x": 329, "y": 229}, {"x": 272, "y": 209}, {"x": 368, "y": 150}, {"x": 440, "y": 185}, {"x": 500, "y": 142}, {"x": 468, "y": 122}, {"x": 461, "y": 78}],
      [{"x": 163, "y": 236},{"x": 228, "y": 289}, {"x": 318, "y": 238}, {"x": 273, "y": 213}, {"x": 356, "y": 146}, {"x": 416, "y": 181}, {"x": 552, "y": 109}, {"x": 522, "y": 61}]
    ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
      [{"x": 73, "y": 250}],
      [{"x": 103, "y": 225}],
      [{"x": 138, "y": 198}],
      [{"x": 180, "y": 202}]
    ]
  },
  "èŠå­å®¶": {
    "æ²³é‚Š":           [
  [{"x": 249, "y": 281}, {"x": 337, "y": 195}],
  [{"x": 255, "y": 295}, {"x": 391, "y": 219}],
  [{"x": 250, "y": 286}, {"x": 323, "y": 232}, {"x": 434, "y": 239}],
  [{"x": 253, "y": 291}, {"x": 346, "y": 239}]
  ],
    "é…’é¤¨":           [
  [{"x": 249, "y": 288}, {"x": 300, "y": 186}, {"x": 369, "y": 147}, {"x": 495, "y": 209}],
  [{"x": 256, "y": 293}, {"x": 304, "y": 186}, {"x": 366, "y": 149}, {"x": 532, "y": 161}],
  [{"x": 374, "y": 358}, {"x": 621, "y": 194}, {"x": 596, "y": 168}],
  [{"x": 381, "y": 353}, {"x": 557, "y": 245}, {"x": 564, "y": 222}]
  ],
    "ææ¸…ç…§å®¶":       [
  [{"x": 200, "y": 286}],
  [{"x": 144, "y": 291}],
  [{"x": 173, "y": 240}],
  [{"x": 230, "y": 255}]
  ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
  [{"x": 73, "y": 250}],
  [{"x": 103, "y": 225}],
  [{"x": 138, "y": 198}],
  [{"x": 180, "y": 202}]
  ],
    "åŸé–€":           [
  [{"x": 461, "y": 394}],
  [{"x": 461, "y": 393}, {"x": 541, "y": 407}],
  [{"x": 410, "y": 394}],
  [{"x": 505, "y": 351}]
  ],
    "è¡™é–€":           [
  [{"x": 495, "y": 280}, {"x": 561, "y": 241}, {"x": 587, "y": 261}],
  [{"x": 499, "y": 277}, {"x": 555, "y": 245}, {"x": 637, "y": 278}],
  [{"x": 501, "y": 277}, {"x": 633, "y": 204}],
  [{"x": 502, "y": 275}, {"x": 627, "y": 203}, {"x": 677, "y": 239}]
  ],
    "è¨ºæ‰€":           [
  [{"x": 500, "y": 278}, {"x": 630, "y": 185}, {"x": 592, "y": 142}, {"x": 627, "y": 127}],
  [{"x": 500, "y": 279}, {"x": 689, "y": 163}],
  [{"x": 500, "y": 279}, {"x": 641, "y": 182}, {"x": 599, "y": 143}, {"x": 652, "y": 103}, {"x": 684, "y": 118}],
  [{"x": 495, "y": 281}, {"x": 653, "y": 176}]
  ],
    "æ›¸é™¢":           [
  [{"x": 248, "y": 287}, {"x": 315, "y": 176}, {"x": 394, "y": 118}],
  [{"x": 244, "y": 286}, {"x": 303, "y": 188}, {"x": 363, "y": 151}, {"x": 409, "y": 171}, {"x": 487, "y": 141}, {"x": 431, "y": 97}],
  [{"x": 247, "y": 287}, {"x": 305, "y": 186}, {"x": 363, "y": 149}, {"x": 419, "y": 167}, {"x": 489, "y": 135}, {"x": 462, "y": 82}],
  [{"x": 249, "y": 290}, {"x": 308, "y": 180}, {"x": 362, "y": 149}, {"x": 395, "y": 169}, {"x": 549, "y": 108}, {"x": 520, "y": 58}]
  ],
  "èŠå­å®¶": [
    [{"x": 249, "y": 368}],
    [{"x": 307, "y": 339}],
    [{"x": 391, "y": 299}],
    [{"x": 441, "y": 283}]
  ]
  },
  "åŸé–€": {
    "æ²³é‚Š":           [
  [{"x": 379, "y": 357}, {"x": 259, "y": 277}, {"x": 336, "y": 190}],
  [{"x": 377, "y": 360}, {"x": 264, "y": 276}, {"x": 391, "y": 221}],
  [{"x": 375, "y": 357}, {"x": 296, "y": 310}, {"x": 431, "y": 244}],
  [{"x": 389, "y": 363}, {"x": 243, "y": 291}, {"x": 343, "y": 233}]
  ],
    "é…’é¤¨":           [
  [{"x": 391, "y": 348}, {"x": 557, "y": 242}, {"x": 497, "y": 213}],
  [{"x": 386, "y": 354}, {"x": 557, "y": 247}, {"x": 467, "y": 202}, {"x": 528, "y": 161}],
  [{"x": 381, "y": 354}, {"x": 623, "y": 197}, {"x": 595, "y": 166}],
  [{"x": 379, "y": 362}, {"x": 565, "y": 224}]
  ],
    "ææ¸…ç…§å®¶":       [
  [{"x": 376, "y": 359}, {"x": 200, "y": 292}],
  [{"x": 378, "y": 356}, {"x": 145, "y": 292}],
  [{"x": 380, "y": 362}, {"x": 177, "y": 239}],
  [{"x": 399, "y": 367}, {"x": 226, "y": 254}]
  ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
  [{"x": 391, "y": 363}, {"x": 135, "y": 234}, {"x": 72, "y": 245}],
  [{"x": 387, "y": 367}, {"x": 106, "y": 223}],
  [{"x": 381, "y": 363}, {"x": 194, "y": 272}, {"x": 140, "y": 193}],
  [{"x": 376, "y": 367}, {"x": 138, "y": 233}, {"x": 177, "y": 205}]
  ],
    "èŠå­å®¶":         [
  [{"x": 249, "y": 368}],
  [{"x": 307, "y": 339}],
  [{"x": 388, "y": 356}, {"x": 391, "y": 299}],
  [{"x": 386, "y": 359}, {"x": 441, "y": 283}]
  ],
    "è¡™é–€":           [
  [{"x": 385, "y": 348}, {"x": 557, "y": 241}, {"x": 587, "y": 263}],
  [{"x": 373, "y": 353}, {"x": 559, "y": 240}, {"x": 638, "y": 272}],
  [{"x": 387, "y": 352}, {"x": 637, "y": 205}],
  [{"x": 382, "y": 350}, {"x": 611, "y": 208}, {"x": 673, "y": 236}]
  ],
    "è¨ºæ‰€":           [
  [{"x": 382, "y": 348}, {"x": 642, "y": 187}, {"x": 594, "y": 146}, {"x": 625, "y": 128}],
  [{"x": 380, "y": 350}, {"x": 694, "y": 159}],
  [{"x": 379, "y": 352}, {"x": 631, "y": 189}, {"x": 592, "y": 123}, {"x": 684, "y": 116}],
  [{"x": 381, "y": 349}, {"x": 655, "y": 170}]
  ],
    "æ›¸é™¢":           [
  [{"x": 369, "y": 355}, {"x": 242, "y": 278}, {"x": 307, "y": 180}, {"x": 389, "y": 117}],
  [{"x": 375, "y": 360}, {"x": 251, "y": 249}, {"x": 356, "y": 142}, {"x": 406, "y": 172}, {"x": 489, "y": 140}, {"x": 428, "y": 96}],
  [{"x": 380, "y": 356}, {"x": 244, "y": 271}, {"x": 305, "y": 179}, {"x": 363, "y": 148}, {"x": 428, "y": 174}, {"x": 480, "y": 135}, {"x": 459, "y": 78}],
  [{"x": 377, "y": 355}, {"x": 634, "y": 186}, {"x": 520, "y": 57}]
  ],
  "åŸé–€": [
    [{"x": 465, "y": 392}],
    [{"x": 542, "y": 406}],
    [{"x": 408, "y": 392}],
    [{"x": 508, "y": 353}]
  ]
  },
  "è¡™é–€": {
    "æ²³é‚Š":           [
  [{"x": 553, "y": 244}, {"x": 357, "y": 152}, {"x": 298, "y": 183}, {"x": 338, "y": 190}],
  [{"x": 553, "y": 245}, {"x": 367, "y": 150}, {"x": 307, "y": 178}, {"x": 394, "y": 219}],
  [{"x": 546, "y": 243}, {"x": 362, "y": 148}, {"x": 308, "y": 178}, {"x": 431, "y": 238}],
  [{"x": 548, "y": 242}, {"x": 363, "y": 147}, {"x": 300, "y": 179}, {"x": 346, "y": 233}]
  ],
    "é…’é¤¨":           [
  [{"x": 494, "y": 214}],
  [{"x": 635, "y": 187}, {"x": 574, "y": 142}, {"x": 528, "y": 161}],
  [{"x": 636, "y": 194}, {"x": 592, "y": 166}],
  [{"x": 563, "y": 216}]
  ],
    "ææ¸…ç…§å®¶":       [
  [{"x": 558, "y": 242}, {"x": 361, "y": 350}, {"x": 200, "y": 287}],
  [{"x": 558, "y": 241}, {"x": 359, "y": 352}, {"x": 146, "y": 286}],
  [{"x": 557, "y": 246}, {"x": 363, "y": 348}, {"x": 197, "y": 275}, {"x": 177, "y": 240}],
  [{"x": 564, "y": 242}, {"x": 352, "y": 349}, {"x": 227, "y": 252}]
  ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
  [{"x": 563, "y": 244}, {"x": 350, "y": 346}, {"x": 195, "y": 274}, {"x": 73, "y": 248}],
  [{"x": 566, "y": 244}, {"x": 353, "y": 347}, {"x": 197, "y": 273}, {"x": 105, "y": 224}],
  [{"x": 575, "y": 238}, {"x": 348, "y": 347}, {"x": 194, "y": 277}, {"x": 137, "y": 195}],
  [{"x": 549, "y": 251}, {"x": 352, "y": 347}, {"x": 193, "y": 275}, {"x": 177, "y": 204}]
  ],
    "èŠå­å®¶":         [
  [{"x": 546, "y": 251}, {"x": 261, "y": 394}, {"x": 254, "y": 372}],
  [{"x": 552, "y": 252}, {"x": 354, "y": 351}, {"x": 309, "y": 339}],
  [{"x": 552, "y": 251}, {"x": 399, "y": 330}, {"x": 391, "y": 303}],
  [{"x": 550, "y": 254}, {"x": 459, "y": 297}, {"x": 443, "y": 275}]
  ],
    "åŸé–€":           [
  [{"x": 554, "y": 251}, {"x": 385, "y": 352}, {"x": 465, "y": 392}],
  [{"x": 555, "y": 253}, {"x": 382, "y": 347}, {"x": 494, "y": 412}, {"x": 542, "y": 406}],
  [{"x": 552, "y": 250}, {"x": 385, "y": 352}, {"x": 408, "y": 392}],
  [{"x": 560, "y": 248}, {"x": 485, "y": 285}, {"x": 542, "y": 326}, {"x": 508, "y": 353}]
  ],
    "è¨ºæ‰€":           [
  [{"x": 631, "y": 184}, {"x": 600, "y": 150}, {"x": 628, "y": 129}],
  [{"x": 692, "y": 159}],
  [{"x": 632, "y": 182}, {"x": 596, "y": 145}, {"x": 650, "y": 105}, {"x": 686, "y": 116}],
  [{"x": 651, "y": 177}]
  ],
    "æ›¸é™¢":           [
  [{"x": 636, "y": 188}, {"x": 476, "y": 129}, {"x": 388, "y": 115}],
  [{"x": 642, "y": 183}, {"x": 473, "y": 123}, {"x": 427, "y": 91}],
  [{"x": 642, "y": 189}, {"x": 457, "y": 117}, {"x": 462, "y": 80}],
  [{"x": 645, "y": 197}, {"x": 522, "y": 55}]
  ],
  "è¡™é–€": [
    [{"x": 585, "y": 260}],
    [{"x": 641, "y": 272}],
    [{"x": 634, "y": 211}],
    [{"x": 678, "y": 243}]
  ]
  },
  "è¨ºæ‰€": {
    "æ²³é‚Š":           [
  [{"x": 530, "y": 146}, {"x": 440, "y": 184}, {"x": 364, "y": 150}, {"x": 305, "y": 174}, {"x": 339, "y": 192}],
  [{"x": 532, "y": 144}, {"x": 424, "y": 189}, {"x": 362, "y": 147}, {"x": 304, "y": 178}, {"x": 395, "y": 216}],
  [{"x": 531, "y": 143}, {"x": 438, "y": 190}, {"x": 359, "y": 149}, {"x": 307, "y": 176}, {"x": 437, "y": 242}],
  [{"x": 524, "y": 144}, {"x": 450, "y": 193}, {"x": 364, "y": 152}, {"x": 299, "y": 180}, {"x": 345, "y": 233}]
  ],
    "é…’é¤¨":           [
  [{"x": 574, "y": 153}, {"x": 497, "y": 211}],
  [{"x": 593, "y": 147}, {"x": 534, "y": 160}],
  [{"x": 593, "y": 163}],
  [{"x": 626, "y": 183}, {"x": 562, "y": 221}]
  ],
    "ææ¸…ç…§å®¶":       [
  [{"x": 560, "y": 153}, {"x": 355, "y": 155}, {"x": 278, "y": 195}, {"x": 199, "y": 287}],
  [{"x": 565, "y": 146}, {"x": 443, "y": 173}, {"x": 353, "y": 157}, {"x": 273, "y": 202}, {"x": 232, "y": 291}, {"x": 146, "y": 290}],
  [{"x": 580, "y": 143}, {"x": 436, "y": 182}, {"x": 360, "y": 153}, {"x": 301, "y": 183}, {"x": 210, "y": 277}, {"x": 177, "y": 237}],
  [{"x": 570, "y": 151}, {"x": 390, "y": 163}, {"x": 356, "y": 152}, {"x": 294, "y": 182}, {"x": 230, "y": 250}]
  ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
  [{"x": 560, "y": 149}, {"x": 421, "y": 175}, {"x": 362, "y": 153}, {"x": 291, "y": 187}, {"x": 201, "y": 284}, {"x": 71, "y": 245}],
  [{"x": 595, "y": 153}, {"x": 353, "y": 157}, {"x": 293, "y": 184}, {"x": 200, "y": 283}, {"x": 107, "y": 219}],
  [{"x": 596, "y": 151}, {"x": 430, "y": 176}, {"x": 356, "y": 153}, {"x": 288, "y": 188}, {"x": 201, "y": 286}, {"x": 139, "y": 194}],
  [{"x": 594, "y": 152}, {"x": 429, "y": 169}, {"x": 362, "y": 151}, {"x": 303, "y": 177}, {"x": 197, "y": 286}, {"x": 180, "y": 203}]
  ],
    "èŠå­å®¶":         [
  [{"x": 606, "y": 206}, {"x": 479, "y": 292}, {"x": 372, "y": 360}, {"x": 251, "y": 370}],
  [{"x": 616, "y": 207}, {"x": 376, "y": 345}, {"x": 306, "y": 341}],
  [{"x": 622, "y": 195}, {"x": 452, "y": 305}, {"x": 392, "y": 303}],
  [{"x": 617, "y": 197}, {"x": 475, "y": 289}, {"x": 440, "y": 277}]
  ],
    "åŸé–€":           [
  [{"x": 619, "y": 202}, {"x": 412, "y": 319}, {"x": 465, "y": 390}],
  [{"x": 621, "y": 197}, {"x": 400, "y": 335}, {"x": 461, "y": 392}, {"x": 543, "y": 403}],
  [{"x": 634, "y": 192}, {"x": 419, "y": 314}, {"x": 405, "y": 393}],
  [{"x": 629, "y": 190}, {"x": 488, "y": 283}, {"x": 523, "y": 321}, {"x": 512, "y": 350}]
  ],
    "è¡™é–€":           [
  [{"x": 585, "y": 260}],
  [{"x": 695, "y": 237}, {"x": 641, "y": 272}],
  [{"x": 634, "y": 211}],
  [{"x": 678, "y": 243}]
  ],
    "æ›¸é™¢":           [
  [{"x": 579, "y": 148}, {"x": 463, "y": 122}, {"x": 389, "y": 113}],
  [{"x": 594, "y": 156}, {"x": 462, "y": 122}, {"x": 424, "y": 96}],
  [{"x": 599, "y": 158}, {"x": 463, "y": 121}, {"x": 462, "y": 70}],
  [{"x": 519, "y": 54}]
  ],
  "è¨ºæ‰€": [
    [{"x": 630, "y": 127}],
    [{"x": 691, "y": 162}],
    [{"x": 684, "y": 120}],
    [{"x": 648, "y": 175}]
  ]
  },
  "æ›¸é™¢": {
    "æ²³é‚Š":           [
  [{"x": 496, "y": 139}, {"x": 409, "y": 174}, {"x": 357, "y": 147}, {"x": 308, "y": 177}, {"x": 338, "y": 197}],
  [{"x": 501, "y": 142}, {"x": 403, "y": 183}, {"x": 357, "y": 152}, {"x": 303, "y": 178}, {"x": 393, "y": 218}],
  [{"x": 505, "y": 146}, {"x": 409, "y": 181}, {"x": 362, "y": 147}, {"x": 302, "y": 182}, {"x": 431, "y": 240}],
  [{"x": 494, "y": 151}, {"x": 419, "y": 180}, {"x": 360, "y": 155}, {"x": 302, "y": 183}, {"x": 347, "y": 235}]
  ],
    "é…’é¤¨":           [
  [{"x": 503, "y": 144}, {"x": 494, "y": 211}],
  [{"x": 528, "y": 165}],
  [{"x": 591, "y": 168}],
  [{"x": 560, "y": 140}, {"x": 634, "y": 186}, {"x": 565, "y": 222}]
  ],
    "ææ¸…ç…§å®¶":       [
  [{"x": 501, "y": 149}, {"x": 415, "y": 178}, {"x": 361, "y": 155}, {"x": 301, "y": 180}, {"x": 269, "y": 265}, {"x": 198, "y": 285}],
  [{"x": 506, "y": 150}, {"x": 420, "y": 184}, {"x": 363, "y": 149}, {"x": 301, "y": 182}, {"x": 223, "y": 285}, {"x": 146, "y": 283}],
  [{"x": 501, "y": 148}, {"x": 424, "y": 183}, {"x": 358, "y": 153}, {"x": 286, "y": 191}, {"x": 201, "y": 285}, {"x": 173, "y": 234}],
  [{"x": 499, "y": 150}, {"x": 419, "y": 181}, {"x": 368, "y": 154}, {"x": 304, "y": 181}, {"x": 226, "y": 254}]
  ],
    "ææ¸…ç…§å®¶çš„åº­é™¢": [
  [{"x": 496, "y": 146}, {"x": 404, "y": 184}, {"x": 358, "y": 149}, {"x": 304, "y": 181}, {"x": 255, "y": 268}, {"x": 196, "y": 274}, {"x": 77, "y": 247}],
  [{"x": 506, "y": 140}, {"x": 411, "y": 177}, {"x": 365, "y": 149}, {"x": 297, "y": 184}, {"x": 264, "y": 269}, {"x": 196, "y": 277}, {"x": 108, "y": 224}],
  [{"x": 510, "y": 147}, {"x": 415, "y": 176}, {"x": 366, "y": 145}, {"x": 304, "y": 172}, {"x": 260, "y": 271}, {"x": 193, "y": 271}, {"x": 143, "y": 194}],
  [{"x": 511, "y": 143}, {"x": 427, "y": 181}, {"x": 357, "y": 150}, {"x": 305, "y": 178}, {"x": 243, "y": 286}, {"x": 195, "y": 272}, {"x": 177, "y": 203}]
  ],
    "èŠå­å®¶":         [
  [{"x": 514, "y": 139}, {"x": 638, "y": 181}, {"x": 553, "y": 248}, {"x": 484, "y": 289}, {"x": 245, "y": 373}],
  [{"x": 555, "y": 132}, {"x": 646, "y": 192}, {"x": 379, "y": 338}, {"x": 311, "y": 337}],
  [{"x": 566, "y": 134}, {"x": 634, "y": 189}, {"x": 411, "y": 322}, {"x": 386, "y": 303}],
  [{"x": 551, "y": 135}, {"x": 633, "y": 192}, {"x": 474, "y": 287}, {"x": 442, "y": 276}]
  ],
    "åŸé–€":           [
  [{"x": 572, "y": 143}, {"x": 642, "y": 193}, {"x": 385, "y": 333}, {"x": 460, "y": 391}],
  [{"x": 561, "y": 135}, {"x": 643, "y": 192}, {"x": 413, "y": 321}, {"x": 464, "y": 390}, {"x": 544, "y": 407}],
  [{"x": 564, "y": 136}, {"x": 651, "y": 193}, {"x": 393, "y": 330}, {"x": 408, "y": 396}],
  [{"x": 564, "y": 135}, {"x": 634, "y": 194}, {"x": 497, "y": 276}, {"x": 525, "y": 329}, {"x": 512, "y": 352}]
  ],
    "è¡™é–€":           [
  [{"x": 595, "y": 149}, {"x": 644, "y": 191}, {"x": 569, "y": 230}, {"x": 585, "y": 257}],
  [{"x": 560, "y": 136}, {"x": 700, "y": 230}, {"x": 637, "y": 273}],
  [{"x": 556, "y": 132}, {"x": 637, "y": 207}],
  [{"x": 560, "y": 133}, {"x": 681, "y": 243}]
  ],
    "è¨ºæ‰€":           [
  [{"x": 630, "y": 127}],
  [{"x": 570, "y": 152}, {"x": 655, "y": 197}, {"x": 691, "y": 162}],
  [{"x": 684, "y": 120}],
  [{"x": 549, "y": 133}, {"x": 648, "y": 175}]
  ],
  "æ›¸é™¢": [
    [{"x": 389, "y": 117}],
    [{"x": 428, "y": 96}],
    [{"x": 459, "y": 78}],
    [{"x": 520, "y": 57}]
  ]
  },
};

const poem_png = {
  "æç™½": "assets/images/a.jpg",
  "ææ¸…ç…§": "assets/images/b.jpg",
  "æè€å¸«": "assets/images/c.jpg",
  "èŠå­": "assets/images/d.jpg",
  // â€¦ å…¶ä»–
};


const GAME_SPEED = 3000;
const BACKEND_API_URL = 'http://localhost:8000/api/status';
const POEM_API_URL = 'http://localhost:8000/api/check_poem';

const TARGET_AGENT_ID = 'li_xiucai';
const TARGET_LOCATION_NAME = 'æ›¸é™¢';

// =====================================================================================
// == é‡è¦ï¼šè«‹åœ¨æ­¤è™•è¨­å®šæ‚¨çš„éŸ³è¨Šæª”æ¡ˆè·¯å¾‘                                                ==
// == å¦‚æœæ‚¨ä¹‹å‰å¯ä»¥æ’­æ”¾ï¼Œè«‹ç¢ºä¿é€™è£¡çš„è·¯å¾‘èˆ‡æ‚¨ã€ä¹‹å‰èƒ½æ­£å¸¸æ’­æ”¾æ™‚ã€‘çš„è·¯å¾‘ã€å®Œå…¨ä¸€è‡´ã€‘ã€‚ ==
// == ä¾‹å¦‚ï¼šconst PRESET_AUDIO_URL = 'my_sound.wav'; (å¦‚æœæª”æ¡ˆåœ¨åŒç›®éŒ„ä¸‹)              ==
// == æˆ–ï¼š  const PRESET_AUDIO_URL = 'sounds/my_sound.mp3'; (å¦‚æœåœ¨ sounds å­ç›®éŒ„)      ==
// =====================================================================================
const PRESET_AUDIO_URL = 'data_example.wav'; // <-- è«‹å‹™å¿…æª¢æŸ¥ä¸¦ä¿®æ”¹æ­¤è™•ç‚ºæ‚¨ã€ä¹‹å‰èƒ½æ’­æ”¾ã€‘çš„éŸ³è¨Šæª”æ¡ˆè·¯å¾‘ï¼
// =====================================================================================

console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] PRESET_AUDIO_URL åœ¨è…³æœ¬è¼‰å…¥æ™‚çš„åˆå§‹å€¼:", PRESET_AUDIO_URL);

const PRESET_AUDIO_NAME = 'æŠµé”æç¤ºéŸ³';
let locationEventTriggeredThisCycle = false;

const timeUnits = ["åˆåˆ»", "ä¸€åˆ»", "äºŒåˆ»", "ä¸‰åˆ»", "æ­£"];
const shichen = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"];
let currentShichenIndex = 3;
let currentTimeUnitIndex = 0;
let gameIntervalId = null;
let isPlaying = false;

const gameTimeDisplay = document.getElementById('game-time-display');
const playPauseButton = document.getElementById('play-pause-button');
const nextStepButton = document.getElementById('next-step-button');
const cityMapContainer = document.getElementById('city-map-container');
const infoPanelContainer = document.getElementById('info-panel-container');

const poemDisplay = document.getElementById('poem-display');
const poemLoadingMessage = document.getElementById('poem-loading-message');

const agentElements = {};
const agentSpeechBubbles = {};
const agentInfoPanels = {};
const locationCoordinates = {};

const eventAudioPlayer = document.getElementById('eventAudioPlayer');
const locationEventModal = document.getElementById('locationEventModal');
const closeEventModalButton = document.getElementById('closeEventModalButton');
const eventModalTitle = document.getElementById('eventModalTitle');
const eventModalMessage = document.getElementById('eventModalMessage');
const eventModalPlayPauseButton = document.getElementById('eventModalPlayPauseButton');
const eventModalMessageBox = document.getElementById('eventModalMessageBox');

const routeSelectOrder = {
  'æç™½': 0, 
  'ææ¸…ç…§': 1,
  'æè€å¸«': 2,
  'èŠå­': 3
}

const role_png = { // è§’è‰²åœ–ç‰‡è·¯å¾‘
    "test1": "assets\\images\\test1.png",
    "test2": "assets\\images\\test2.png",
    "æç™½": "assets\\images\\æç™½.png",
    "èŠå­": "assets\\images\\èŠå­.png",
    "ææ¸…ç…§": "assets\\images\\ææ¸…ç…§.png",
    "æè€å¸«": "assets\\images\\æè€å¸«.png",
};

// è¨ˆç®—ä¸¦å„²å­˜æ¯å€‹locationçš„åº§æ¨™åˆ°locationCoordinatesç‰©ä»¶
document.querySelectorAll('#city-map-container .location').forEach(locEl => {
    const locationName = locEl.dataset.locationName;
    if (locationName) {
        const mapRect = cityMapContainer.getBoundingClientRect();
        const locRect = locEl.getBoundingClientRect();
        locationCoordinates[locationName] = {
            x: (locRect.left - mapRect.left) + locEl.offsetWidth / 2,
            y: (locRect.top - mapRect.top) + locEl.offsetHeight / 2,
            name: locationName
        };
    }
});

/**
 * å»ºç«‹ä¸€å€‹æ–°çš„ <img> å…ƒç´ ä¸¦æ’å…¥æŒ‡å®šå®¹å™¨
 * @param {string} name               - agent_idï¼Œç”¨æ–¼è¨­å®š data-name å±¬æ€§
 * @param {HTMLElement} container     - è¦æ’å…¥çš„çˆ¶å®¹å™¨å…ƒç´ 
 * @param {number} [x=0]          - åˆå§‹ X åº§æ¨™ (px)
 * @param {number} [y=0]          - åˆå§‹ Y åº§æ¨™ (px)
 * @returns {HTMLImageElement}        - æ–°å»ºç«‹ä¸¦å·²æ’å…¥å®¹å™¨çš„ <img> å…ƒç´ 
 */
function createRoleImage(name, container, x = 0, y = 0) {
    const img = document.createElement('img');
    const path = role_png[name];

    img.dataset.name   = name;
    img.src            = path;
    // çµ•å°å®šä½ï¼Œä»¥ä¾¿æŒ‡å®šä½ç½®
    img.style.position = 'absolute';

    // x_bias = img.width;
    // y_bias = img.height;
    // // ä¿®æ­£åœ–ç‰‡1/2é•·å¯¬
    // x -= x_bias;
    // y -= y_bias;
    // const x_bias = img.width  / 2;
    // const y_bias = img.height / 2;
    img.style.left     = `${x}px`;
    img.style.top      = `${y}px`;
    // img.addEventListener('load', () => {
    //   const x_bias = img.width  / 2;
    //   const y_bias = img.height / 2;
    //   console.log(name, 'before', img.style.left, img.style.top)
    //   img.style.left = `${x - x_bias}px`;
    //   img.style.top  = `${y - y_bias}px`;
    //   console.log(name, x_bias, y_bias)
      
    //   console.log(name, 'after', img.style.left, img.style.top)
    // }, { once: true });

    // æ’å…¥åˆ°çˆ¶å®¹å™¨
    container.appendChild(img);
    return img;
  }

/**
 * ä»¥äººç‰©idå»ºç«‹(å¦‚æœä¸å­˜åœ¨)ä¸¦ç²å– <img>ï¼Œä¸¦ç”¨éåŒæ­¥å‹•ç•«ç§»å‹•åˆ°æŒ‡å®šx, yåº§æ¨™
 * @param {string} name      - agent_id
 * @param {number} x         - ç›®æ¨™ x åº§æ¨™ (px)
 * @param {number} y         - ç›®æ¨™ y åº§æ¨™ (px)
 * @param {number} [speed]   - å‹•ç•«é€Ÿåº¦ (åƒç´ /æ¯«ç§’)ï¼Œé è¨­å€¼ 0.5 px/ms
 * @returns {Animation}      - Web Animations API çš„ Animation ç‰©ä»¶ï¼Œå¯åšå¾ŒçºŒæš«åœç­‰æ“ä½œ
 */
function move2xy(name, x, y, speed = 0.5) {
    // é è¨­æŠŠåœ–ç‰‡æ”¾åœ¨ id="city-map-container" çš„ DIV å…§
    const container = document.getElementById('city-map-container');
  
    // å–äººç‰©åœ–ç‰‡è·¯å¾‘
    const path = role_png[name];
    if (!path) {
      console.warn(`æ‰¾ä¸åˆ°åç¨±ç‚º "${name}" çš„åœ–ç‰‡è·¯å¾‘`);
      return;
    }
  
    // å˜—è©¦åœ¨ container è£¡æ‰¾å·²æœ‰çš„ <img data-name="...">
    let img = container.querySelector(`img[data-name="${name}"]`);
    // è‹¥ä¸å­˜åœ¨å°±å»ºç«‹ä¸€å€‹æ–°çš„
    if (!img) {
        img = createRoleImage(name, container, x, y);
    }

    // x_bias = img.width / 2;
    // y_bias = img.height / 2;
    // // ä¿®æ­£åœ–ç‰‡1/2é•·å¯¬
    // x -= x_bias;
    // y -= y_bias;

    // è®€å–ç›®å‰åº§æ¨™
    const style  = getComputedStyle(img);
    let startX = parseFloat(style.left) || 0;
    let startY = parseFloat(style.top)  || 0;
  
    // åˆ©ç”¨è·é›¢è¨ˆç®—ç§»å‹•æ™‚é–“
    const dx       = x - startX;
    const dy       = y - startY;
    const distance = Math.hypot(dx, dy);
    const duration = distance / speed; 
  
    // è¨­å®šç§»å‹•å‹•ç•«ï¼Œä¸¦ä¸”ä½¿ç”¨éåŒæ­¥åœ¨èƒŒæ™¯åŸ·è¡Œï¼ŒæŒçºŒæ™‚é–“ç‚º duration æ¯«ç§’
    const animation = img.animate(
      [
        { left: `${startX}px`, top: `${startY}px` },
        { left: `${x}px`,      top: `${y}px`      }
      ],
      {
        duration,
        easing: 'linear',
        fill: 'forwards'
      }
    );
  
    return animation;
  }


/**
 * éåŒæ­¥è®“è§’è‰²æ²¿è‘—ä¸€ç³»åˆ—xyåº§æ¨™ä¾åºç§»å‹•
 * @param {string} name              - agent_id
 * @param {{x: number, y: number}[]} path    - åº§æ¨™é™£åˆ—
 * @param {number} [speed=0.5]       - å‹•ç•«é€Ÿåº¦ (px/ms)ï¼Œé è¨­å€¼ 0.5 px/ms
 */
function move2xyWithRoute(name, path, speed = 0.5) {
    let index = 0;
  
    function step() {
      if (index >= path.length) return;  // å…¨éƒ¨åº§æ¨™éƒ½è·‘å®Œå°±çµæŸ
  
      const { x, y } = path[index++]; // å–å‡ºè¦å‰å¾€çš„åº§æ¨™
      const animation = move2xy(name, x, y, speed); // éåŒæ­¥ç§»å‹•
      if (!animation) return; // æ‰¾ä¸åˆ°è§’è‰²å°±ç›´æ¥çµæŸ
  
      // æŠµé”åº§æ¨™å¾Œå†å‘¼å«ç§»å‹•åˆ°ä¸‹ä¸€å€‹åº§æ¨™
      animation.onfinish = step;
    }
  
    // é–‹å§‹ç§»å‹•åˆ°ç¬¬ä¸€å€‹åº§æ¨™
    step();
  }

/**
 * éš¨æ©Ÿå¾ routeTable[a][b] é¸ä¸€æ¢å°šæœªä½¿ç”¨çš„è·¯å¾‘ï¼Œä¸¦å‘¼å« move2xyWithRoute
 * @param {string} agentId    - è§’è‰² ID
 * @param {string} from       - èµ·é»åç¨± (e.g. "æ²³é‚Š")
 * @param {string} to         - çµ‚é»åç¨± (e.g. "æ›¸é™¢")
 */
function moveWithLocation(agentId, from, to) {
  const routes = routeTable[from]?.[to] || [];
  if (routes.length === 0) {
    console.warn(`æ²’æœ‰å¯ç”¨çš„è·¯å¾‘ï¼š${from} â†’ ${to}`);
    return;
  }

  const key = `${from}â†’${to}`;

  // ç›´æ¥å¾ routeSelectOrder æ‹¿ indexï¼Œä¸åšä»»ä½•é©—è­‰
  const chosenIdx = routeSelectOrder[agentId];

  // å–å‡ºè·¯å¾‘ä¸¦åŸ·è¡Œç§»å‹•
  const path = routes[chosenIdx];
  move2xyWithRoute(agentId, path, 0.1);
}

/**
 * é‡è¨­æ‰€æœ‰å·²ç”¨éè·¯å¾‘çš„è¨˜éŒ„
 * æˆ–å‚³å…¥ç‰¹å®š from/to åªé‡è¨­é‚£çµ„è·¯å¾‘
 * @param {string} [from]  - ï¼ˆå¯é¸ï¼‰èµ·é»
 * @param {string} [to]    - ï¼ˆå¯é¸ï¼‰çµ‚é»
 */
function resetUsedRoutes(from, to) {
  if (from && to) {
    const key = `${from}â†’${to}`;
    delete usedRoutes[key];
  } else {
    usedRoutes = {};
  }
}


/**
 * å‘å¾Œç«¯ /api/status ç™¼é€ GET è«‹æ±‚
 * @param {string} time - æŸ¥è©¢åƒæ•¸ timeï¼Œä¾‹å¦‚ '2025-05-20T21:00:00'
 * @param {string} name - æŸ¥è©¢åƒæ•¸ nameï¼Œä¾‹å¦‚ 'Alice'
 * @returns {Promise<Object>} - å¾Œç«¯å›å‚³çš„ JSON ç‰©ä»¶
 */
async function fetchStatus(time, name) {
  // 1. åºåˆ—åŒ– query string
  const params = new URLSearchParams({ time, name });

  // 2. ç”¨å®Œæ•´ç¶²å€å‘¼å«
  const url = `${BACKEND_API_URL}?${params.toString()}`;

  // 3. ç™¼é€ GET è«‹æ±‚
  const response = await fetch(url, {
    method: 'GET',
    headers: {
      'Accept': 'application/json'
    }
  });

  if (!response.ok) {
    throw new Error(`å¾Œç«¯å›æ‡‰éŒ¯èª¤ï¼š${response.status} ${response.statusText}`);
  }

  // 4. è§£æä¸¦å›å‚³ JSON
  return await response.json();
}

// åœ¨æ­£æ–¹å½¢å€å¡Šé¡¯ç¤ºç‹€æ…‹è³‡è¨Š
function displayStatus(area, name, activity, think, loc) {
  const box = document.getElementById(`status-${area}`);
  if (!box) {
      console.warn(`æ‰¾ä¸åˆ°å€å¡Š status-${area}`);
      return;
  }
  box.innerHTML = `
      <strong>${name}</strong><br>
      ğŸƒ æ´»å‹•ï¼š${activity}<br>
      ğŸ’­ æ€è€ƒï¼š${think}<br>
      ğŸ“ ä½ç½®ï¼š${loc}
  `;
}

// ç¯„ä¾‹ï¼šå‘¼å«æ™‚å°±æœƒç¢ºå¯¦æ‰“åˆ° http://localhost:8000/api/status

// fetchStatus('00:15', 'æç™½')
//   .then(data => {
//     console.log('å¾Œç«¯å›å‚³è³‡æ–™ï¼š', data);
//     // é€™è£¡å¯ä»¥åšé€²ä¸€æ­¥è™•ç†æˆ–æ›´æ–°ç•«é¢
//   })
//   .catch(err => {
//     console.error('API è«‹æ±‚å¤±æ•—ï¼š', err);
//   });

// å‡è¨­æˆ‘å€‘ç”¨ä¸€å€‹ç‰©ä»¶ä¾†è¨˜éŒ„æ¯å€‹è§’è‰²çš„ç›®å‰ä½ç½®
const currentPositions = {};

/**
 * æ›´æ–°è§’è‰²ç‹€æ…‹ä¸¦è§¸ç™¼ç§»å‹•èˆ‡é¡¯ç¤º
 * @param {string} name - è§’è‰²åç¨±ï¼Œä¾‹å¦‚ 'æç™½'
 * @param {string} time - æ™‚é–“å­—ä¸²ï¼Œä¾‹å¦‚ '2025-05-20T21:00:00'
 */
async function updateCharacterStatus(name, time) {
  try {
    // 1. æ‹¿åˆ°å¾Œç«¯å›å‚³çš„ç‹€æ…‹
    const { time: t, activity, think, location: newLocation } = await fetchStatus(time, name);

    // 2. è®€å–ä¸¦å„²å­˜ä¹‹å‰çš„ä½ç½®ï¼Œè‹¥æ²’ç´€éŒ„å‰‡é è¨­å¾ newLocation è‡ªèº«é–‹å§‹
    const prevLocation = currentPositions[name] || newLocation;
    console.log(prevLocation, newLocation);
   // 3. å¦‚æœä½ç½®è®Šäº†ï¼Œæ‰è§¸ç™¼éš¨æ©Ÿè·¯å¾‘ç§»å‹•
    moveWithLocation(name, prevLocation, newLocation);

    // 4. æ›´æ–°ç›®å‰ä½ç½®
    currentPositions[name] = newLocation;

    // 5. é¡¯ç¤ºè§’è‰²ç‹€æ…‹
    displayStatus(name, name, activity, think, newLocation);

  } catch (err) {
    console.error(`æ›´æ–°è§’è‰²ç‹€æ…‹å¤±æ•—ï¼š${err.message}`, err);
  }
}


// ç¯„ä¾‹å‘¼å«
// updateCharacterStatus('æç™½', '2025-05-20T21:00:00');

// 1. ç”¢ç”Ÿå¾ 00:00 åˆ° 23:45ï¼Œæ¯ 15 åˆ†é˜ä¸€æ ¼çš„æ™‚é–“é™£åˆ—
const timeSlots = Array.from(
  { length: 24 * 4 },
  (_, i) => {
    const h = String(Math.floor(i / 4)).padStart(2, '0');
    const m = String((i % 4) * 15).padStart(2, '0');
    return `${h}:${m}`;
  }
);

// 2. è¨˜éŒ„ç›®å‰çš„æ™‚é–“ç´¢å¼•ï¼ˆåˆå§‹ç‚º 0ï¼Œä¹Ÿå°±æ˜¯ "00:00"ï¼‰
let currentIndex = 0;

// 3. æ¯æ¬¡å‘¼å«çš„æ›´æ–°å‡½å¼
function goToNextTime() {
  // å¦‚æœå·²ç¶“è¶…éæœ€å¾Œä¸€å€‹ï¼Œå°±ç¶­æŒåœ¨æœ€å¾Œ
  if (currentIndex < timeSlots.length - 1) {
    currentIndex++;
  }
  const nextTime = timeSlots[currentIndex];
  // çœŸæ­£çš„è§’è‰²ç‹€æ…‹æ›´æ–°å‘¼å«
  updateCharacterStatus('æç™½', nextTime);
  updateCharacterStatus('ææ¸…ç…§', nextTime);
  updateCharacterStatus('æè€å¸«', nextTime);
  updateCharacterStatus('èŠå­', nextTime);

  fetchPoem('æç™½', nextTime);
  fetchPoem('ææ¸…ç…§', nextTime);
  fetchPoem('æè€å¸«', nextTime);
  fetchPoem('èŠå­', nextTime);
  // åŒæ­¥æ›´æ–°ç•«é¢ä¸Šçš„æ™‚é–“é¡¯ç¤ºï¼ˆå¯é¸ï¼‰
  document.getElementById('game-time-display').textContent = `æ™‚é–“: ${nextTime}`;
}


function goToPrevTime() {
  if (currentIndex > 0) {
    currentIndex--;
    const prevTime = timeSlots[currentIndex];
    // æ›´æ–°æ‰€æœ‰è§’è‰²
    updateCharacterStatus('æç™½', prevTime);
    updateCharacterStatus('ææ¸…ç…§', prevTime);
    updateCharacterStatus('æè€å¸«', prevTime);
    updateCharacterStatus('èŠå­', prevTime);
    // æ›´æ–°ç•«é¢ä¸Šçš„æ™‚é–“é¡¯ç¤º
    gameTimeDisplay.textContent = `æ™‚é–“: ${prevTime}`;
  }
}

let autoInterval = null;

document.addEventListener('DOMContentLoaded', () => {
  const playBtn = document.getElementById('play-pause-button');
  const nextBtn = document.getElementById('next-step-button');
  const prevBtn = document.getElementById('prev-step-button');

  // æ’­æ”¾ / æš«åœ æŒ‰éˆ•
  playBtn.addEventListener('click', () => {
    if (autoInterval) {
      clearInterval(autoInterval);
      autoInterval = null;
      playBtn.textContent = 'æ’­æ”¾';
    } else {
      goToNextTime();
      autoInterval = setInterval(goToNextTime, 5000);
      playBtn.textContent = 'æš«åœ';
    }
  });

  // ä¸‹ä¸€æ­¥
  nextBtn.addEventListener('click', () => {
    if (autoInterval) {
      clearInterval(autoInterval);
      autoInterval = null;
      playBtn.textContent = 'æ’­æ”¾';
    }
    goToNextTime();
  });

  // ä¸Šä¸€æ­¥
  prevBtn.addEventListener('click', () => {
    if (autoInterval) {
      clearInterval(autoInterval);
      autoInterval = null;
      playBtn.textContent = 'æ’­æ”¾';
    }
    goToPrevTime();
  });

  // ä¸€é€²ä¾†å…ˆé¡¯ç¤ºä¸€æ¬¡æ™‚é–“
  updateCharacterStatus('æç™½', timeSlots[currentIndex]);
  gameTimeDisplay.textContent = `æ™‚é–“: ${timeSlots[currentIndex]}`;
});


//   const container = document.getElementById('city-map-container');
//   const svgNS     = 'http://www.w3.org/2000/svg';

//   // 1. å»ºç«‹ã€å°é½Š overlay
//   const rect = container.getBoundingClientRect();
//   const overlay = document.createElementNS(svgNS, 'svg');
//   overlay.id = 'draw-overlay';
//   overlay.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
//   overlay.setAttribute('width',  rect.width);
//   overlay.setAttribute('height', rect.height);
//   overlay.style.position = 'absolute';
//   overlay.style.top      = '0';
//   overlay.style.left     = '0';
//   container.appendChild(overlay);

//   // 2. å»º polyline
//   const polyline = document.createElementNS(svgNS, 'polyline');
//   polyline.setAttribute('fill',         'none');
//   polyline.setAttribute('stroke',       '#f00');
//   polyline.setAttribute('stroke-width', '2');
//   overlay.appendChild(polyline);

//   // 3. é»æ“Šæ”¶é»ã€æ›´æ–° polyline
//   const points = [];
//   container.addEventListener('click', e => {
//     const r = container.getBoundingClientRect();
//     const x = e.clientX - r.left;
//     const y = e.clientY - r.top;
//     points.push({ x: Math.round(x), y: Math.round(y) });
//     polyline.setAttribute(
//       'points',
//       points.map(p => `${p.x},${p.y}`).join(' ')
//     );
//   });

// // 4. åŒ¯å‡ºæˆ "{x, y}, {x, y}, ..." ä¸æ›è¡Œ
// document.getElementById('export-coords')
//   .addEventListener('click', () => {
//     const coordsString = points
//       .map(p => `{"x": ${p.x}, "y": ${p.y}}`)
//       .join(', ');
//     document.getElementById('coords-output').textContent = coordsString;
//   });

//   // 5. é‡è¨­è·¯å¾‘æŒ‰éˆ•
// document.getElementById('reset-path')
// .addEventListener('click', () => {
//   // æ¸…ç©ºè³‡æ–™é™£åˆ—
//   points.length = 0;
//   // æ¸…æ‰ polyline
//   polyline.setAttribute('points', '');
//   // æ¸…ç©ºè¼¸å‡ºå€
//   document.getElementById('coords-output').textContent = '';
// });

// åŸè©©æ¨¡çµ„ï¼šæœªåŒ…å«èƒŒæ™¯åœ–ç‰‡ï¼Œåƒ…æœ‰é¡¯ç¤ºè©©è©ã€æ’­æ”¾éŸ³æª”
(function(){
  // ==== æ³¨å…¥æ¨£å¼ ====
  const css = `
  /* å…¨åŸŸå”¯ä¸€å‰ç¶´ï¼špoem-modal- */
  .poem-modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .poem-modal-content {
    background: #fffaf0;
    border: 2px solid #deb887;
    border-radius: 1rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    max-width: 600px;
    width: 90%;
    padding: 2rem;
    position: relative;
    text-align: center;
    font-family: 'Noto Serif TC', serif;
  }
  .poem-modal-close {
    position: absolute;
    top: 0.5rem; right: 0.8rem;
    background: none;
    border: none;
    font-size: 2rem;
    color: #a9a9a9;
    cursor: pointer;
  }
  .poem-modal-close:hover { color: #778899; }
  .poem-modal-title { font-size: 1.75rem; color: #8b4513; margin-bottom: 1rem; }
  .poem-modal-text {
    font-size: 1.15em;
    line-height: 1.9;
    white-space: pre-wrap;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    margin: 1rem 0;
    background: rgba(245,245,220,0.8);
    border: 1px dashed #d2b48c;
    border-radius: 0.5rem;
    padding: 1rem;
    max-height: 60vh;
    overflow-y: auto;
  }
  .poem-modal-text.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .poem-modal-controls { margin-top: 1rem; }
  .poem-modal-controls button {
    background: #8fbc8f;
    color: #fff;
    border: none;
    border-radius: 0.5rem;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
  }
  .poem-modal-controls button:hover { background: #3cb371; }
  .poem-modal-controls button:disabled { background: #98fb98; cursor: not-allowed; }
  .poem-modal-status {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 0.375rem;
    display: none;
    font-size: 0.9rem;
  }
  .poem-modal-status.info { background: #e0ffff; color: #008080; border:1px solid #afeeee; }
  .poem-modal-status.warning { background: #fffacd; color: #b8860b; border:1px solid #fff0b3; }
  .poem-modal-status.error { background: #ffcccb; color: #c00; border:1px solid #ffb3b3; }
  `;
  const style = document.createElement('style');
  style.setAttribute('type', 'text/css');
  style.textContent = css;
  document.head.appendChild(style);

  /**
 * åœ¨é é¢ä¸Šå½ˆå‡ºä¸€å€‹è©©è©åŸèª¦è¦–çª—ï¼Œä¸¦åŒæ­¥æ’­æ”¾éŸ³è¨Š
 * @param {string} poemText - è©©è©æ–‡å­—ï¼Œä¿ç•™æ›è¡Œèˆ‡æ ¼å¼
 * @param {string} audioPath - éŸ³è¨Šæª”æ¡ˆè·¯å¾‘
 */
  // ==== ä¸»å‡½å¼ï¼Œä¸å«é‡è³¼åŠŸèƒ½ ====
  function showPoemAudioModal(poemText, audioPath) {
    
    
    const mainPlayBtn = document.getElementById('play-pause-button');
    if (mainPlayBtn && mainPlayBtn.textContent === 'æš«åœ') {
      console.log('[è‡ªå‹•æš«åœ] åœ¨é¡¯ç¤ºè©©è©å‰ï¼Œå…ˆè‡ªå‹•æš«åœä¸»ç•«é¢æ’­æ”¾ã€‚');
      mainPlayBtn.click();
    }
    
    // æª¢æŸ¥æˆ–ç”Ÿæˆ DOM çµæ§‹
    let overlay = document.querySelector('.poem-modal-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'poem-modal-overlay';
      overlay.innerHTML = `
        <div class="poem-modal-content">
          <button class="poem-modal-close" aria-label="é—œé–‰">&times;</button>
          <div class="poem-modal-title">è©©è©åŸèª¦</div>
          <div class="poem-modal-status info"></div>
          <div class="poem-modal-text"></div>
          <div class="poem-modal-controls">
            <button class="poem-modal-play">æ’­æ”¾åŸèª¦</button>
          </div>
          <audio class="poem-modal-audio" style="display:none;"></audio>
        </div>`;
      document.body.appendChild(overlay);

      // ç¶å®šé—œé–‰æŒ‰éˆ•
      overlay.querySelector('.poem-modal-close').addEventListener('click', () => {
        overlay.style.display = 'none';
        const audio = overlay.querySelector('.poem-modal-audio');
        audio.pause(); audio.currentTime = 0;
        overlay.querySelector('.poem-modal-text').classList.remove('visible');
        const btn = overlay.querySelector('.poem-modal-play');
        btn.textContent = 'æ’­æ”¾åŸèª¦'; btn.disabled = false;
        overlay.querySelector('.poem-modal-status').style.display = 'none';
      });
    }

    const statusEl = overlay.querySelector('.poem-modal-status');
    const textEl   = overlay.querySelector('.poem-modal-text');
    const playBtn  = overlay.querySelector('.poem-modal-play');
    const audioEl  = overlay.querySelector('.poem-modal-audio');

    // é¡¯ç¤ºæ–‡å­—èˆ‡ç‹€æ…‹
    textEl.textContent = poemText.trim();
    textEl.classList.remove('visible');
    statusEl.style.display = 'none';

    // è¨­éŸ³è¨Šæº
    audioEl.src = audioPath;
    audioEl.load();
    playBtn.disabled = true;
    playBtn.textContent = 'æº–å‚™åŸèª¦';

    // é¡¯ç¤º overlay
    overlay.style.display = 'flex';

    // play äº‹ä»¶ä¸€æ¬¡æ€§ç›£è½
    const onPlayOnce = () => {
      textEl.classList.add('visible');
      playBtn.textContent = 'æš«åœåŸèª¦';
      playBtn.disabled = false;
      statusEl.className = 'poem-modal-status info';
      statusEl.textContent = 'æ­£åœ¨åŸèª¦â€¦';
      statusEl.style.display = 'block';
      audioEl.removeEventListener('play', onPlayOnce);
    };
    audioEl.addEventListener('play', onPlayOnce);

    // å˜—è©¦è‡ªå‹•æ’­æ”¾
    audioEl.play().catch(err => {
      statusEl.className = 'poem-modal-status warning';
      statusEl.textContent = 'è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹ï¼Œè«‹æ‰‹å‹•é»æ“Šæ’­æ”¾ã€‚';
      statusEl.style.display = 'block';
      playBtn.textContent = 'æ’­æ”¾åŸèª¦';
      playBtn.disabled = false;
      audioEl.removeEventListener('play', onPlayOnce);
    });

    // æ’­æ”¾/æš«åœåˆ‡æ›
    playBtn.onclick = () => {
      if (audioEl.paused || audioEl.ended) {
        if (audioEl.ended) audioEl.currentTime = 0;
        textEl.classList.add('visible');
        audioEl.play().catch(e => {
          statusEl.className = 'poem-modal-status error';
          statusEl.textContent = `æ’­æ”¾å¤±æ•—ï¼š${e.message}`;
          statusEl.style.display = 'block';
        });
      } else {
        audioEl.pause();
      }
    };

    // ç›£è½ pause / ended / error
    audioEl.onpause = () => {
      playBtn.textContent = 'æ’­æ”¾åŸèª¦';
      statusEl.className = 'poem-modal-status info';
      statusEl.textContent = 'åŸèª¦å·²æš«åœã€‚';
      statusEl.style.display = 'block';
    };
    audioEl.onended = () => {
      playBtn.textContent = 'é‡æ–°åŸèª¦';
      statusEl.className = 'poem-modal-status info';
      statusEl.textContent = 'åŸèª¦å®Œç•¢ã€‚';
      statusEl.style.display = 'block';
    };
    audioEl.onerror = () => {
      statusEl.className = 'poem-modal-status error';
      statusEl.textContent = 'éŸ³è¨Šæ’­æ”¾ç™¼ç”ŸéŒ¯èª¤ã€‚';
      statusEl.style.display = 'block';
      playBtn.textContent = 'æ’­æ”¾åŸèª¦';
      playBtn.disabled = false;
    };
  }

  // å°‡å‡½å¼æš´éœ²åˆ°å…¨åŸŸï¼Œä»»ä½•æ¨¡çµ„å¯ä»¥é€é`showPoemAudioModal`ä¾†ä½¿ç”¨
  window.showPoemAudioModal = showPoemAudioModal;
})();

// è¨˜éŒ„å·²é¡¯ç¤ºéè©©è©è¦–çª—çš„è§’è‰²
const shownPoemAgents = new Set();

/**
 * å‘å¾Œç«¯ /api/check_poem ç™¼é€ GET è«‹æ±‚ï¼Œä¸¦æ ¹æ“šå›å‚³æ±ºå®šæ˜¯å¦é¡¯ç¤ºåŸè©©è¦–çª—
 * æ¯å€‹è§’è‰²åªæœƒè§¸ç™¼ä¸€æ¬¡ showPoemAudioModal
 * @param {string} name - è§’è‰²åç¨±
 * @param {string} time - æ™‚é–“å­—ä¸²ï¼Œä¾‹å¦‚ '00:15'
 * @returns {Promise<Object|null>} - å¾Œç«¯å›å‚³çš„è³‡æ–™æˆ– null
 */
async function fetchPoem(name, time) {
  try {
    // å¦‚æœå·²ç¶“é¡¯ç¤ºéè©©è©ï¼Œå°±ç›´æ¥è·³é
    if (shownPoemAgents.has(name)) return null;

    // æ§‹å»º query string
    const params = new URLSearchParams({ time, name });
    const url = `${POEM_API_URL}?${params.toString()}`;

    // ç™¼é€ GET è«‹æ±‚
    const response = await fetch(url, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });

    // éŒ¯èª¤è™•ç†
    if (!response.ok) {
      console.error(`è©©è© API å›æ‡‰éŒ¯èª¤ï¼š${response.status} ${response.statusText}`);
      return null;
    }

    // è§£æ JSON
    const data = await response.json();
    console.log('fetchPoem å›å‚³è³‡æ–™ï¼š', data);

    // åˆ¤æ–·æ˜¯å¦éœ€è¦é¡¯ç¤ºåŸè©©è¦–çª—
    const shouldShowPoem = data.time_ === true || data[time] === true;
    if (shouldShowPoem) {
      // æ¨™è¨˜æ­¤è§’è‰²å·²é¡¯ç¤ºé
      shownPoemAgents.add(name);
      console.log('è§¸ç™¼åŸèª¦è¦–çª—æ¢ä»¶æˆç«‹ï¼Œé¡¯ç¤ºè©©è©åŸèª¦');

      // è½‰æ›å¾Œç«¯çš„ sound ç‚ºæ­£ç¢ºæª”åï¼Œå»é™¤å†’è™Ÿä¸¦åŠ ä¸Š .mp3
      const soundFileKey = data.sound.replace(/:/g, '');
      const soundUrl = `assets/audio/${soundFileKey}.mp3`;
      showPoemAudioModal(data.poem, soundUrl);
    }

    return data;
  } catch (err) {
    console.error('fetchPoem ç™¼ç”ŸéŒ¯èª¤ï¼š', err);
    return null;
  }
}


// ç¯„ä¾‹ç”¨æ³•
// fetchPoem('æç™½', '00:00')
//   .then(poemData => {
//     if (poemData) {
//       // é€™è£¡å¯ä»¥é€²ä¸€æ­¥æŠŠè©©è©é¡¯ç¤ºåˆ°ç•«é¢ä¸Š
//       console.log(poemData);
//     }
//   });

// city-map-containeråº§æ¨™ï¼š
// x: 160.40000915527344, y: 51.60000228881836

// function getCurrentGameTimeString() {
//     return `${shichen[currentShichenIndex]}${timeUnits[currentTimeUnitIndex]}`;
// }

// function advanceGameTime() {
//     currentTimeUnitIndex++;
//     if (currentTimeUnitIndex >= timeUnits.length) {
//         currentTimeUnitIndex = 0;
//         currentShichenIndex++;
//         if (currentShichenIndex >= shichen.length) {
//             currentShichenIndex = 0;
//         }
//     }
//     return getCurrentGameTimeString();
// }

// async function fetchAndUpdateGameState() {
//     const currentGameTime = getCurrentGameTimeString();
//     gameTimeDisplay.textContent = `æ™‚é–“: ${currentGameTime}`;
//     const requestUrl = `${BACKEND_API_URL}?time=${encodeURIComponent(currentGameTime)}`;
//     try {
//         const response = await fetch(requestUrl);
//         if (!response.ok) {
//             throw new Error(`éŠæˆ²ç‹€æ…‹ API è«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}`);
//         }
//         const gameState = await response.json();
//         if (gameState.agents) {
//             updateAgents(gameState.agents);
//         } else {
//             console.warn("è­¦å‘Šï¼šæ”¶åˆ°çš„éŠæˆ²ç‹€æ…‹ä¸­æ²’æœ‰ä»£ç†äººè³‡æ–™ã€‚");
//         }
//     } catch (error) {
//         console.error("åµéŒ¯[JS-API]: ç²å–éŠæˆ²ç‹€æ…‹å¤±æ•—:", error);
//         if (isPlaying) togglePlayPause();
//     }
// }

// function createOrUpdateAgentElement(agentId, agentData) {
//     let agentEl = agentElements[agentId];
//     let speechBubbleEl = agentSpeechBubbles[agentId];
//     if (!agentEl) {
//         agentEl = document.createElement('div');
//         agentEl.id = `agent-${agentId}`;
//         agentEl.className = 'agent';
//         agentEl.textContent = agentData.name.substring(0, 1);
//         const h = Math.floor(Math.random() * 360);
//         const s = Math.floor(Math.random() * 30 + 70);
//         const l = Math.floor(Math.random() * 20 + 40);
//         agentEl.style.backgroundColor = `hsl(${h}, ${s}%, ${l}%)`;
//         cityMapContainer.appendChild(agentEl);
//         agentElements[agentId] = agentEl;
//         speechBubbleEl = document.createElement('div');
//         speechBubbleEl.className = 'speech-bubble';
//         const speechBubbleInner = document.createElement('div');
//         speechBubbleInner.className = 'speech-bubble-inner';
//         speechBubbleEl.appendChild(speechBubbleInner);
//         agentEl.appendChild(speechBubbleEl);
//         agentSpeechBubbles[agentId] = speechBubbleEl;
//         const panel = document.createElement('div');
//         panel.className = 'agent-info-panel';
//         panel.id = `info-${agentId}`;
//         panel.innerHTML = `
//             <h2>${agentData.name}</h2>
//             <p><strong>ä½ç½®:</strong> <span class="agent-location"></span></p>
//             <p><strong>è¡Œå‹•:</strong> <span class="agent-action"></span></p>
//             <p><strong>æƒ³æ³•:</strong> <span class="agent-thought"></span></p>
//             <hr style="border-color: #eee8d5; margin: 10px 0;">
//             <h3>ä»Šæ—¥è¡Œç¨‹</h3>
//             <ul class="agent-schedule-list"></ul>`;
//         infoPanelContainer.appendChild(panel);
//         agentInfoPanels[agentId] = {
//             location: panel.querySelector('.agent-location'),
//             action: panel.querySelector('.agent-action'),
//             thought: panel.querySelector('.agent-thought'),
//             scheduleList: panel.querySelector('.agent-schedule-list'),
//         };
//     }
//     return { agentEl, speechBubbleEl };
// }

// function updateAgents(agentsDataFromBackend) {
//     if (!agentsDataFromBackend) return;
//     for (const agentId in agentsDataFromBackend) {
//         const agentBackendData = agentsDataFromBackend[agentId];
//         const { agentEl, speechBubbleEl } = createOrUpdateAgentElement(agentId, agentBackendData);
//         const currentAgentLocationName = agentBackendData.location;
//         const targetLocationCoords = locationCoordinates[currentAgentLocationName];
//         if (targetLocationCoords) {
//             const agentWidth = agentEl.offsetWidth || 35;
//             const agentHeight = agentEl.offsetHeight || 35;
//             agentEl.style.left = (targetLocationCoords.x - agentWidth / 2) + 'px';
//             agentEl.style.top = (targetLocationCoords.y - agentHeight / 2) + 'px';
//         } else {
//             if (!agentEl.style.left) agentEl.style.left = '10px';
//             if (!agentEl.style.top) agentEl.style.top = '10px';
//         }
//         if (agentBackendData.dialogue && agentBackendData.dialogue.trim() !== "" && agentBackendData.dialogue.trim() !== "ï¼ˆ...ï¼‰") {
//             speechBubbleEl.firstChild.textContent = agentBackendData.dialogue;
//             speechBubbleEl.style.display = 'block';
//         } else {
//             speechBubbleEl.style.display = 'none';
//         }
//         const panel = agentInfoPanels[agentId];
//         if (panel) {
//             panel.location.textContent = currentAgentLocationName;
//             panel.action.textContent = agentBackendData.action;
//             panel.thought.textContent = agentBackendData.thought;
//             panel.scheduleList.innerHTML = '';
//             if (agentBackendData.schedule_today && Array.isArray(agentBackendData.schedule_today)) {
//                 agentBackendData.schedule_today.forEach(event => {
//                     const listItem = document.createElement('li');
//                     listItem.textContent = `${event.time_str} - ${event.location} - ${event.action}`;
//                     if (event.time_str === getCurrentGameTimeString()) {
//                         listItem.style.fontWeight = 'bold';
//                         listItem.style.color = '#d33682';
//                     }
//                     panel.scheduleList.appendChild(listItem);
//                 });
//             }
//         }
//         if (agentId === TARGET_AGENT_ID && currentAgentLocationName === TARGET_LOCATION_NAME) {
//             if (!locationEventTriggeredThisCycle) {
//                 console.log(`[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] äº‹ä»¶è§¸ç™¼æ¢ä»¶é”æˆ: ä»£ç†äºº ${agentId} åœ¨åœ°é» ${currentAgentLocationName}`);
//                 triggerLocationAudioEvent(agentBackendData.name, currentAgentLocationName);
//                 locationEventTriggeredThisCycle = true;
//             }
//         } else if (agentId === TARGET_AGENT_ID && currentAgentLocationName !== TARGET_LOCATION_NAME) {
//             if (locationEventTriggeredThisCycle) {
//                 locationEventTriggeredThisCycle = false;
//             }
//         }
//     }
// }

// function gameStep() {
//     advanceGameTime();
//     fetchAndUpdateGameState();
// }

// function togglePlayPause() {
//     isPlaying = !isPlaying;
//     if (isPlaying) {
//         playPauseButton.textContent = 'æš«åœ';
//         gameStep();
//         gameIntervalId = setInterval(gameStep, GAME_SPEED);
//     } else {
//         playPauseButton.textContent = 'æ’­æ”¾';
//         clearInterval(gameIntervalId);
//     }
// }

// function showEventModalMessage(text, type = 'info') {
//     eventModalMessageBox.textContent = text;
//     eventModalMessageBox.className = `message-box ${type}`;
//     eventModalMessageBox.style.display = 'block';
// }
// function hideEventModalMessage() {
//     eventModalMessageBox.style.display = 'none';
// }

// function triggerLocationAudioEvent(agentName, locationName) {
//     console.log(`[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] triggerLocationAudioEvent è¢«å‘¼å«ã€‚ä»£ç†äºº: ${agentName}, åœ°é»: ${locationName}, PRESET_AUDIO_URL çš„å€¼æ˜¯: '${PRESET_AUDIO_URL}'`);

//     eventModalTitle.textContent = `${agentName} å·²æŠµé” ${locationName}ï¼`;
//     eventModalMessage.textContent = `å³å°‡æ’­æ”¾æç¤ºéŸ³: ${PRESET_AUDIO_NAME}`;
//     locationEventModal.style.display = 'flex';
//     hideEventModalMessage();

//     // --- ç°¡åŒ–å¾Œçš„è­¦å‘Šæ¢ä»¶ ---
//     // åƒ…ç•¶ PRESET_AUDIO_URL æœªè¨­å®š (null, undefined, ç©ºå­—ä¸², åƒ…ç©ºç™½) æ™‚æ‰è­¦å‘Š
//     if (!PRESET_AUDIO_URL || PRESET_AUDIO_URL.trim() === '') {
//             const warningMsg = 'è­¦å‘Šï¼šPRESET_AUDIO_URL æœªè¨­å®šæœ‰æ•ˆçš„éŸ³è¨Šæª”æ¡ˆè·¯å¾‘ã€‚è«‹åœ¨ç¨‹å¼ç¢¼ä¸­ä¿®æ”¹ã€‚';
//             console.warn("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] è§¸ç™¼è­¦å‘Š (è·¯å¾‘æœªè¨­å®š):", warningMsg, "ç›®å‰ PRESET_AUDIO_URL:", PRESET_AUDIO_URL);
//             showEventModalMessage(warningMsg, 'warning');
//             eventModalPlayPauseButton.disabled = true;
//             return;
//     }
//     // å¦‚æœ PRESET_AUDIO_URL æ˜¯ 'data_example.wav'ï¼Œæˆ‘å€‘å‡è¨­ä½¿ç”¨è€…å¯èƒ½æ•…æ„ä½¿ç”¨ç¯„ä¾‹éŸ³è¨Šï¼Œä¸å†å› æ­¤è­¦å‘Šï¼Œ
//     // ä½†æœƒåœ¨ä¸»æ§å°æç¤ºã€‚
//     if (PRESET_AUDIO_URL === 'data_example.wav') {
//         console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] æç¤ºï¼šç›®å‰ä½¿ç”¨çš„æ˜¯é è¨­ç¯„ä¾‹éŸ³è¨Š 'data_example.wav'ã€‚å¦‚æœé€™ä¸æ˜¯æ‚¨æœŸæœ›çš„ï¼Œè«‹ä¿®æ”¹ PRESET_AUDIO_URLã€‚");
//     }
//     // --- è­¦å‘Šæ¢ä»¶çµæŸ ---

//     eventModalPlayPauseButton.disabled = false;
//     console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] è¨­å®š eventAudioPlayer.src ç‚º:", PRESET_AUDIO_URL);
//     eventAudioPlayer.src = PRESET_AUDIO_URL;
    
//     console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] å‘¼å« eventAudioPlayer.load()");
//     eventAudioPlayer.load(); 

//     console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] å˜—è©¦å‘¼å« eventAudioPlayer.play()");
//     const playPromise = eventAudioPlayer.play();
//     if (playPromise !== undefined) {
//         playPromise.then(_ => {
//             console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] éŸ³è¨Šè‡ªå‹•æ’­æ”¾æˆåŠŸã€‚");
//             eventModalPlayPauseButton.textContent = 'æš«åœéŸ³è¨Š';
//             showEventModalMessage('éŸ³è¨Šå·²é–‹å§‹æ’­æ”¾ã€‚', 'info');
//         }).catch(error => {
//             console.error("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] éŸ³è¨Šè‡ªå‹•æ’­æ”¾å¤±æ•—:", error);
//             eventModalPlayPauseButton.textContent = 'æ’­æ”¾éŸ³è¨Š';
//             showEventModalMessage('ç€è¦½å™¨å¯èƒ½é˜»æ­¢äº†éŸ³è¨Šè‡ªå‹•æ’­æ”¾ã€‚è«‹é»æ“ŠæŒ‰éˆ•æ‰‹å‹•æ’­æ”¾ã€‚', 'warning');
//         });
//     } else {
//         console.warn("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] eventAudioPlayer.play() æœªè¿”å› Promiseã€‚");
//     }
// }

// closeEventModalButton.addEventListener('click', () => {
//     locationEventModal.style.display = 'none';
//     eventAudioPlayer.pause();
//     eventAudioPlayer.currentTime = 0;
//     eventModalPlayPauseButton.textContent = 'æ’­æ”¾éŸ³è¨Š';
//     hideEventModalMessage();
// });

// eventModalPlayPauseButton.addEventListener('click', () => {
//     console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] æ‰‹å‹•æ’­æ”¾/æš«åœæŒ‰éˆ•é»æ“Šã€‚ç›®å‰ src:", eventAudioPlayer.src, "paused:", eventAudioPlayer.paused, "ended:", eventAudioPlayer.ended);
//     if (!eventAudioPlayer.src || eventAudioPlayer.src === window.location.href) {
//         const errorMsg = 'éŒ¯èª¤ï¼šæ²’æœ‰æœ‰æ•ˆçš„éŸ³è¨Šä¾†æºã€‚è«‹æª¢æŸ¥ PRESET_AUDIO_URL è¨­å®šã€‚';
//         console.error("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ]", errorMsg);
//         showEventModalMessage(errorMsg, 'error');
//         return;
//     }
//     if (eventAudioPlayer.paused || eventAudioPlayer.ended) {
//         if(eventAudioPlayer.ended) {
//             console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] éŸ³è¨Šå·²çµæŸï¼Œé‡è¨­ currentTime ç‚º 0ã€‚");
//             eventAudioPlayer.currentTime = 0;
//         }
//         console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] æ‰‹å‹•å˜—è©¦æ’­æ”¾éŸ³è¨Šã€‚");
//         eventAudioPlayer.play().catch(error => {
//             console.error("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] æ‰‹å‹•æ’­æ”¾å¤±æ•—:", error);
//             showEventModalMessage(`æ’­æ”¾å¤±æ•—: ${error.message}`, 'error');
//         });
//     } else {
//         console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] æ‰‹å‹•å˜—è©¦æš«åœéŸ³è¨Šã€‚");
//         eventAudioPlayer.pause();
//     }
// });

// eventAudioPlayer.addEventListener('play', () => {
//     console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] event: play (éŸ³è¨Šé–‹å§‹æ’­æ”¾)");
//     eventModalPlayPauseButton.textContent = 'æš«åœéŸ³è¨Š';
//     if (locationEventModal.style.display === 'flex') showEventModalMessage('éŸ³è¨Šæ’­æ”¾ä¸­...', 'info');
// });
// eventAudioPlayer.addEventListener('pause', () => {
//     console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] event: pause (éŸ³è¨Šå·²æš«åœ)");
//     eventModalPlayPauseButton.textContent = 'æ’­æ”¾éŸ³è¨Š';
// });
// eventAudioPlayer.addEventListener('ended', () => {
//     console.log("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] event: ended (éŸ³è¨Šæ’­æ”¾å®Œç•¢)");
//     eventModalPlayPauseButton.textContent = 'é‡æ’­éŸ³è¨Š';
//     if (locationEventModal.style.display === 'flex') showEventModalMessage('éŸ³è¨Šæ’­æ”¾å®Œç•¢ã€‚', 'info');
// });
// eventAudioPlayer.addEventListener('error', (e) => {
//     console.error("[éŸ³è¨ŠåµéŒ¯æ—¥èªŒ] event: error (æ’­æ”¾æ™‚ç™¼ç”ŸéŒ¯èª¤)", "Error Event Object:", e, "MediaError Object:", eventAudioPlayer.error);
//     let msg = "æ’­æ”¾äº‹ä»¶éŸ³è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚";
//     if(eventAudioPlayer.error) {
//         msg += ` (éŒ¯èª¤ç¢¼: ${eventAudioPlayer.error.code}, è¨Šæ¯: ${eventAudioPlayer.error.message || 'ç„¡è©³ç´°è¨Šæ¯'})`;
//         switch(eventAudioPlayer.error.code) {
//             case MediaError.MEDIA_ERR_ABORTED: msg = 'éŸ³è¨Šæ’­æ”¾è¢«ä½¿ç”¨è€…ä¸­æ­¢ã€‚'; break;
//             case MediaError.MEDIA_ERR_NETWORK: msg = 'ä¸‹è¼‰éŸ³è¨Šæ™‚ç™¼ç”Ÿç¶²è·¯éŒ¯èª¤ã€‚è«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘æ˜¯å¦æ­£ç¢ºä¸”å¯è¨ªå•ã€‚'; break;
//             case MediaError.MEDIA_ERR_DECODE: msg = 'è§£ç¢¼éŸ³è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚æª”æ¡ˆå¯èƒ½å·²æå£æˆ–æ ¼å¼ä¸æ”¯æ´ã€‚'; break;
//             case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED: msg = 'éŸ³è¨Šä¾†æºæ ¼å¼ä¸æ”¯æ´æˆ–è·¯å¾‘éŒ¯èª¤ã€‚è«‹ç¢ºèª PRESET_AUDIO_URL æŒ‡å‘æœ‰æ•ˆçš„éŸ³è¨Šæª”æ¡ˆã€‚'; break;
//             default: msg = `æœªçŸ¥éŸ³è¨ŠéŒ¯èª¤ (ä»£ç¢¼: ${eventAudioPlayer.error.code})ã€‚`; break;
//         }
//     }
//     showEventModalMessage(msg, 'error');
// });

// async function fetchAndDisplayPoem() {
//     if (poemLoadingMessage) poemLoadingMessage.style.display = 'block';
//     if (poemDisplay) poemDisplay.innerHTML = '';
//     try {
//         const response = await fetch(POEM_API_URL);
//         if (!response.ok) {
//             throw new Error(`è©©æ­Œ API è«‹æ±‚å¤±æ•—: ${response.status} ${response.statusText}`);
//         }
//         const data = await response.json();
//         if (poemLoadingMessage) poemLoadingMessage.style.display = 'none';
//         if (data.poem) {
//             const preElement = document.createElement('pre');
//             preElement.textContent = data.poem;
//             if (poemDisplay) poemDisplay.appendChild(preElement);
//         } else {
//             if (poemDisplay) poemDisplay.textContent = "æœªèƒ½ç²å–è©©è©ã€‚";
//         }
//     } catch (error) {
//         console.error("ç²å–è©©æ­Œå¤±æ•—:", error);
//         if (poemLoadingMessage) poemLoadingMessage.style.display = 'none';
//         if (poemDisplay) poemDisplay.textContent = `ç²å–è©©æ­Œæ™‚å‡ºéŒ¯: ${error.message}`;
//     }
// }

// window.onload = async () => {
//     gameTimeDisplay.textContent = `æ™‚é–“: ${getCurrentGameTimeString()}`;
//     await fetchAndUpdateGameState();
//     await fetchAndDisplayPoem(); 

//     playPauseButton.addEventListener('click', togglePlayPause);
//     nextStepButton.addEventListener('click', () => {
//         if (isPlaying) { togglePlayPause(); }
//         gameStep();
//     });
//     console.log("åµéŒ¯[JS-INIT]: åˆå§‹åŒ–å®Œæˆã€‚");
// };